<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>蔚蓝档案 | 什亭之箱 - 频道官网</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        :root{
            --page-width:1920px;
            --cover-height:960px;
            --bg:#0f1720;
            --accent:#ffb86b;
            --text:#ffffff;
            --panel: rgba(255,255,255,0.03);
            --panel-border: rgba(255,255,255,0.06);
            --shadow: 0 10px 28px rgba(0,0,0,0.34);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", sans-serif;
        }
        html,body{height:100%;margin:0;background:var(--bg);color:var(--text);}
        .page{width:100%;max-width:1920px;margin:0 auto;}
        .heading-m{margin:0 0 10px;font-size:18px;letter-spacing:.2px}
        .muted{margin:0;color:rgba(255,255,255,0.80);line-height:1.6}
        .footer-stack{display:flex;flex-direction:column;align-items:center;gap:10px}
        .footer-inner{display:flex;flex-direction:column;align-items:center;gap:8px}
        .mt-16{margin-top:16px}
        /* Cover */
        .cover{
            position:relative;
            width:100%;
            height:clamp(320px, 50vh, 640px);
            overflow:hidden;
            display:flex;
            align-items:center;
            justify-content:center;
            background-color:#111;
        }
        .cover img{
            display:block;
            width:100%;
            height:100%;
            object-fit:cover;
            -webkit-user-select:none;
            user-select:none;
        }
        .cover-raster{
            position:absolute;
            inset:0;
            width:100%;
            height:100%;
            object-fit:cover;
            display:none;
        }
        .cover .overlay{
            position:absolute;
            inset:0;
            display:flex;
            align-items:center;
            justify-content:center;
            pointer-events:none;
            background:linear-gradient(180deg, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0.45) 70%);
        }
        .title{
            text-align:center;
            color:var(--text);
            text-shadow:0 6px 24px rgba(0,0,0,0.6);
            pointer-events:auto;
            padding:0 16px;
        }
        .channel-name{
            font-size:72px;
            font-weight:700;
            letter-spacing:2px;
            margin:0 0 8px;
            line-height:1.08;
            word-break:break-word;
        }
        .channel-sub{
            font-size:20px;
            opacity:0.9;
            margin:0;
        }

        /* Events bar */
        .events-bar{
            position:relative;
            width:100%;
            height:400px;
            overflow:hidden;
            margin:20px 0;
        }
        .events-viewport{overflow:hidden;border-radius:12px}
        .events-viewport{touch-action:pan-y;cursor:grab}
        .events-viewport:active{cursor:grabbing}
        .events-container{
            display:flex;
            width:100%;
            height:100%;
            transition:none;
            gap:0;
            will-change:transform;
            transform: translate3d(0,0,0);
        }
        .event-item{
            flex:0 0 100%;
            box-sizing:border-box;
            height:100%;
            background-size:cover;
            background-position:center;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            text-shadow:0 2px 8px rgba(0,0,0,0.8);
            font-size:36px;
            font-weight:700;
            border-radius:10px;
            overflow:hidden;
        }
        .event-item.lazy{background-color:#111;filter:blur(2px);opacity:0.98}
        .event-item.loaded{filter:none;transition:filter .28s ease,opacity .28s ease;opacity:1}
        .event-item{transform:translateZ(0);transition:transform 220ms cubic-bezier(.2,.85,.2,1)}
        .event-item.is-active{transform:scale(1.01)}
        /* 紧凑事件卡样式 */
        .events-card{padding:16px}
        .events-card .events-viewport{height:220px}
        .events-card .events-viewport > .events-container{height:100%}
        .events-card .event-item{font-size:20px;font-weight:700}

        /* Main content */
        main{
            padding:
                clamp(16px, 4vw, 56px)
                calc(clamp(16px, 5vw, 80px) + env(safe-area-inset-right, 0px))
                clamp(16px, 4vw, 56px)
                calc(clamp(16px, 5vw, 80px) + env(safe-area-inset-left, 0px));
            background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
            color:var(--text);
        }
        .cols{display:flex;gap:clamp(16px, 3vw, 40px);align-items:flex-start;}
        .left{flex:1;min-width:0;}
        .right{width:380px;}
        .card{background:var(--panel);border:1px solid var(--panel-border);border-radius:14px;padding:clamp(16px, 2vw, 24px);margin-bottom:clamp(16px, 2vw, 24px);box-shadow:var(--shadow);}
        .grid{
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:20px;
            margin-top:12px;
        }
        .post-item{
            height:160px;
            border-radius:12px;
            overflow:hidden;
            display:flex;
            align-items:flex-end;
            text-decoration:none;
            color:#fff;
            background:#222;
            position:relative;
            box-shadow:0 10px 24px rgba(0,0,0,0.28);
            transform: translateZ(0);
            transition: transform var(--btn-transition) ease, box-shadow var(--btn-transition) ease, filter var(--btn-transition) ease;
        }
        .post-item:hover,
        .post-item:focus{
            transform: translateY(-2px);
            box-shadow:0 16px 34px rgba(0,0,0,0.36);
        }
        .post-item:active{transform: translateY(-1px)}
        .post-item:focus{outline:2px solid rgba(255,184,107,0.18);outline-offset:2px}

        .post-item.has-img{background-size:cover;background-position:center;}
        .post-item::before{
            content:"";
            position:absolute;
            inset:0;
            background:linear-gradient(180deg, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.55) 85%);
            pointer-events:none;
        }
        .post-title{
            position:relative;
            width:100%;
            padding:12px;
            border-radius:0;
            line-height:1.25;
            color:#fff;
            text-shadow:0 2px 12px rgba(0,0,0,0.55);
            word-break:break-word;
        }
        .post-title span{display:inline}

        footer{
            padding:24px;
            padding-bottom:calc(24px + env(safe-area-inset-bottom, 0px));
            text-align:center;
            color:#9aa3b2;
            font-size:14px;
        }
        @media (max-width: 1200px) {
            main { padding: 24px 40px; }
            .cols { flex-direction: column; gap: 20px; }
            .left { min-width: unset; }
            .right { width: 100%; }
            .grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        }
        @media (max-width: 768px) {
            main {
                padding:
                    16px
                    calc(16px + env(safe-area-inset-right, 0px))
                    16px
                    calc(16px + env(safe-area-inset-left, 0px));
            }
            .events-bar { height: 250px; }
            .channel-name { font-size: clamp(34px, 9vw, 52px); letter-spacing: 1px; }
            .channel-sub { font-size: 14px; }
            .cover { height: clamp(260px, 38vh, 420px); }
            .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
            .post-item { height: 140px; border-radius: 12px; }
            .post-title { padding: 10px; font-size: 14px; }
            .card { border-radius: 14px; }
        }

        @media (max-width: 420px) {
            .grid { grid-template-columns: 1fr; }
            .post-item { height: 150px; }
            .events-card { padding: 14px; }
            .events-card .events-viewport { height: 200px; }
            .events-card .event-item { font-size: 18px; }
        }

        @media (hover: none) {
            .post-item:hover,
            .post-item:focus{ transform:none; box-shadow:0 10px 24px rgba(0,0,0,0.28); }
            .btn:hover,
            .btn:focus{ transform:none; box-shadow:0 10px 24px rgba(0,0,0,0.35); }
            .fixed-admin-btn:hover,
            .fixed-admin-btn:focus{ transform:none; }
        }

        @media (prefers-reduced-motion: reduce) {
            .events-container,
            .event-item,
            .post-item,
            .btn,
            .fixed-admin-btn{
                transition:none !important;
                animation:none !important;
            }
        }
        /* 按钮样式与动效 */
        :root{
            --btn-transition:160ms;
            --btn-scale-hover:1.04;
            --btn-scale-press:1.02;
        }
        .btn{
            width:100%;
            padding:12px;
            border-radius:8px;
            border:0;
            background:var(--accent);
            color:#081018;
            font-weight:600;
            cursor:pointer;
            transition:transform var(--btn-transition) cubic-bezier(.2,.8,.2,1), box-shadow var(--btn-transition) cubic-bezier(.2,.8,.2,1), opacity var(--btn-transition) ease;
            transform-origin:center center;
            will-change:transform;
            -webkit-tap-highlight-color: transparent;
            backface-visibility: hidden;
            transform: translateZ(0);
        }
        .btn:hover,
        .btn:focus{
            transform:scale(var(--btn-scale-hover));
            box-shadow:0 10px 24px rgba(0,0,0,0.35);
        }
        .btn:active{
            transform:scale(var(--btn-scale-press));
        }
        .btn:focus{outline:2px solid rgba(255,184,107,0.18)}

        /* 右下角较小管理按钮 */
        .fixed-admin-btn{
            position:fixed;
            right:20px;
            bottom:calc(20px + env(safe-area-inset-bottom, 0px));
            z-index:9999;
            display:inline-block;
            padding:8px 10px;
            font-size:14px;
            background:var(--accent);
            color:#081018;
            border-radius:8px;
            text-decoration:none;
            box-shadow:0 6px 18px rgba(0,0,0,0.35);
            transition:transform var(--btn-transition) ease, opacity var(--btn-transition) ease;
        }
        .fixed-admin-btn:hover,
        .fixed-admin-btn:focus{
            transform:scale(1.06);
        }
        .fixed-admin-btn:active{transform:scale(1.02)}
        /* 页脚中单独的按钮，避免占满整行并保持动画稳定 */
        footer .btn{
            width:auto;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding:10px 18px;
            min-width:120px;
        }
    </style>
</head>
<body>
    <div class="page" role="main">
        <header class="cover" aria-hidden="false">
            <!-- Cover uses a raster image from repo root -->
            <svg class="cover-img svg-cover-fill" role="img" aria-label="频道封面" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 1920 960" preserveAspectRatio="xMidYMid slice">
            <image href="fmi.jpg" width="1920" height="960" preserveAspectRatio="xMidYMid slice" />
    <defs>
        <linearGradient id="g" x1="0" x2="1">
            <stop offset="0" stop-color="#2b5876"/>
            <stop offset="1" stop-color="#4e4376"/>
        </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <g opacity="0.08">
        <circle cx="1600" cy="200" r="300" fill="#fff"/>
        <circle cx="300" cy="700" r="200" fill="#fff"/>
    </g>
            </svg>
            <!-- raster fallback for fmi.jpg: shown if the file loads successfully -->
            <img id="coverRaster" class="cover-raster" src="fmi.jpg" alt="频道封面图片备用">
            <div class="overlay" aria-hidden="true">
                <div class="title" role="banner">
                    <h1 class="channel-name" data-key="channelName">什亭之箱</h1>
                    <p class="channel-sub" data-key="channelSub">发现 · 收藏 · 分享</p>
                </div>
            </div>
        </header>

        <!-- Events moved into main content as a card -->

        <main>
            <div class="cols">
                <section class="left" aria-labelledby="about-heading">
                    <div class="card" id="about-heading">
                        <h2 class="heading-m">关于频道</h2>
                        <p class="muted" data-key="aboutText">
                            这是“什亭之箱子”的主页区域。放置频道介绍、近期更新和精选内容预览。
                        </p>
                    </div>

                    <div class="card events-card">
                        <h3 class="heading-m">重要活动</h3>
                        <div class="events-viewport">
                            <div class="events-container" id="events-container">
                                <!-- Events will be injected here -->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="heading-m">热门讨论 / 帖子</h3>
                        <div class="grid" id="posts-grid">
                            <!-- posts will be injected from assets/site-content.json -->
                        </div>
                    </div>
                </section>

                <!-- right column removed; info moved to footer -->
                
            </div>
        </main>

        <footer>
            <div class="footer-stack">
                <span data-key="footerText">© 什亭之箱 - 管理团队 版权所有</span>
                <div class="footer-inner">
                    <div>频道建立时间：2024/09/19</div>
                    <div>频道已经正常运行： <span id="run-days">0</span>天</div>
                    <div class="mt-16">
                        <a class="btn" href="https://qq.com" target="_blank" rel="noopener">加入我们</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <!-- 右下角管理按钮（小尺寸，跳转到 admin-v.html 登录页） -->
    <a href="admin-v.html" class="fixed-admin-btn" aria-label="管理网页">管理网页</a>
    <script>
    (async function(){
        // 尝试显示根目录下的 fmi.jpg 作为封面栅格图；若加载失败，保留 SVG 渐变为后备
        (function tryCoverRaster(){
            const raster = document.getElementById('coverRaster');
            if(!raster) return;
            const probe = new Image();
            probe.onload = ()=>{
                raster.style.display = 'block';
                console.log('封面 fmi.jpg 加载成功，已显示。');
            };
            probe.onerror = ()=>{
                raster.style.display = 'none';
                console.warn('封面 fmi.jpg 加载失败，使用 SVG 渐变后备。');
            };
            // 小心缓存问题，添加时间戳以便管理员更新后能即时刷新
            probe.src = 'fmi.jpg' + (location.search.includes('nocache') ? '' : ('?v=' + (Date.now())));
        })();
        const cfgPath = 'assets/site-content.json';
        try{
            const res = await fetch(cfgPath, {cache:'no-cache'});
            if(!res.ok) throw new Error('网络错误');
            const data = await res.json();
            if(data.pageTitle) document.title = data.pageTitle;
            const setText = (selector, value)=>{
                const el = document.querySelector(selector);
                if(el && value!==undefined) el.textContent = value;
            };
            setText('[data-key=channelName]', data.channelName);
            setText('[data-key=channelSub]', data.channelSub);
            setText('[data-key=aboutText]', data.aboutText);
            setText('[data-key=footerText]', data.footerText);
            const tagsEl = document.getElementById('tags-list');
            if(tagsEl && Array.isArray(data.tags)) tagsEl.textContent = data.tags.join(' · ');
            // 计算频道运行天数（自 2024-09-19）
            const runEl = document.getElementById('run-days');
            if(runEl){
                const start = new Date('2024-09-19T00:00:00');
                const compute = ()=>{
                    const now = new Date();
                    const diff = Math.floor((now - start) / (1000*60*60*24));
                    runEl.textContent = diff >= 0 ? diff : 0;
                };
                compute();
                // 每小时更新一次（足够用于每日计数）
                setInterval(compute, 60*60*1000);
            }

            function isSafeColor(value){
                const v = String(value || '').trim();
                if(/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(v)) return true;
                if(/^rgba?\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}(\s*,\s*(0|1|0?\.\d+))?\s*\)$/i.test(v)) return true;
                return false;
            }

            function isSafeFontSize(value){
                const v = String(value || '').trim();
                const m = v.match(/^(\d{1,3})(?:\.(\d+))?(px|rem|em|%)$/i);
                if(!m) return false;
                const n = Number(m[1] + (m[2] ? ('.' + m[2]) : ''));
                return Number.isFinite(n) && n >= 8 && n <= 96;
            }

            // 只允许 <span style="color/font-size">，其它标签/属性一律剥离
            function sanitizeLimitedHtml(input){
                const tpl = document.createElement('template');
                tpl.innerHTML = String(input || '');
                const out = document.createElement('span');

                const walk = (node, parent) => {
                    Array.from(node.childNodes).forEach(ch => {
                        if(ch.nodeType === Node.TEXT_NODE){
                            parent.appendChild(document.createTextNode(ch.textContent || ''));
                            return;
                        }
                        if(ch.nodeType !== Node.ELEMENT_NODE) return;
                        const tag = (ch.tagName || '').toLowerCase();
                        if(tag === 'span'){
                            const span = document.createElement('span');
                            const style = ch.getAttribute('style') || '';
                            style.split(';').forEach(part => {
                                const idx = part.indexOf(':');
                                if(idx === -1) return;
                                const key = part.slice(0, idx).trim().toLowerCase();
                                const val = part.slice(idx + 1).trim();
                                if(key === 'color' && isSafeColor(val)) span.style.color = val;
                                if(key === 'font-size' && isSafeFontSize(val)) span.style.fontSize = val;
                            });
                            walk(ch, span);
                            parent.appendChild(span);
                            return;
                        }
                        walk(ch, parent);
                    });
                };

                walk(tpl.content, out);
                return out.innerHTML;
            }

            function isSafeHref(href){
                const h = String(href || '').trim();
                if(!h) return '';
                if(/^https?:\/\//i.test(h)) return h;
                if(/^\//.test(h)) return h;
                if(/^\.\/?/.test(h)) return h;
                if(/^\.\.\//.test(h)) return h;
                return '';
            }

            const postsGrid = document.getElementById('posts-grid');
            const posts = Array.isArray(data.hotPosts)
                ? data.hotPosts
                : Array.isArray(data.latestVideos)
                    ? data.latestVideos.filter(Boolean).map(t => ({ titleHtml: String(t), image: '', href: '' }))
                    : [];

            if(postsGrid && Array.isArray(posts)){
                postsGrid.innerHTML = '';
                posts.forEach(p => {
                    const titleHtml = sanitizeLimitedHtml(p && p.titleHtml !== undefined ? p.titleHtml : '');
                    const image = String((p && p.image) || '').trim();
                    const href = isSafeHref(p && p.href);

                    const a = document.createElement('a');
                    a.className = 'post-item' + (image ? ' has-img' : '');
                    a.href = href || '#';
                    a.target = href ? '_blank' : '';
                    a.rel = href ? 'noopener' : '';
                    a.tabIndex = 0;

                    if(image){
                        // cache-bust to reflect admin updates when appropriate
                        const url = image + (location.search.includes('nocache') ? '' : ('?v=' + (Date.now())));
                        a.style.backgroundImage = `url(${url})`;
                    }

                    const title = document.createElement('div');
                    title.className = 'post-title';
                    title.innerHTML = titleHtml || '';
                    a.appendChild(title);

                    if(!href){
                        a.addEventListener('click', (ev)=>{ ev.preventDefault(); });
                        a.style.cursor = 'default';
                        a.style.opacity = '0.92';
                    }

                    postsGrid.appendChild(a);
                });
            }
            if(data.adminButton){
                const admin = document.querySelector('.fixed-admin-btn');
                if(admin){
                    if(data.adminButton.text) admin.textContent = data.adminButton.text;
                    // 强制管理按钮指向登录页 admin-v.html，避免直接跳转到未验证的 admin-nom.html
                    admin.setAttribute('href', 'admin-v.html');
                }
            }
            // Load events
            const eventsContainer = document.getElementById('events-container');
            if(eventsContainer && Array.isArray(data.events)){
                eventsContainer.innerHTML = '';
                data.events.forEach(event => {
                    const div = document.createElement('div');
                    div.className = 'event-item lazy';
                    // store image to load later when visible
                    div.dataset.src = event.image;
                    div.textContent = event.title;
                    eventsContainer.appendChild(div);
                });
                // Lazy-load background images only when item becomes visible inside the events card
                (function setupLazyLoading(){
                    const rootEl = eventsContainer.parentElement || document.body;
                    const io = new IntersectionObserver((entries, obs)=>{
                        entries.forEach(en=>{
                            if(en.isIntersecting){
                                const el = en.target;
                                const src = el.dataset.src;
                                if(src){
                                    const img = new Image();
                                    img.onload = ()=>{
                                        el.style.backgroundImage = `url(${src})`;
                                        el.classList.remove('lazy');
                                        el.classList.add('loaded');
                                    };
                                    img.onerror = ()=>{
                                        el.classList.remove('lazy');
                                        el.classList.add('loaded');
                                    };
                                    // cache-bust to reflect admin updates when appropriate
                                    img.src = src + (location.search.includes('nocache') ? '' : ('?v=' + (Date.now())));
                                }
                                obs.unobserve(el);
                            }
                        });
                    }, { root: rootEl, rootMargin: '0px', threshold: 0.5 });
                    Array.from(eventsContainer.children).forEach(child=> io.observe(child));
                })();
                // Auto slide — 基于像素位移以确保每次移动为可视区宽度
                let currentIndex = 0;
                const totalEvents = data.events.length;
                if(totalEvents > 1){
                    // 使用 eventsContainer 的当前可见宽度作为项宽
                    const viewportEl = eventsContainer.parentElement; // .events-viewport
                    const updateItemWidths = ()=>{
                        const w = (viewportEl && (viewportEl.clientWidth || viewportEl.getBoundingClientRect().width)) || eventsContainer.clientWidth || eventsContainer.getBoundingClientRect().width;
                        Array.from(eventsContainer.children).forEach(item=>{
                            item.style.flex = `0 0 ${Math.round(w)}px`;
                        });
                    };
                    const setActiveClass = ()=>{
                        const children = eventsContainer.children;
                        for(let i=0;i<children.length;i++){
                            const el = children[i];
                            if(!el || !el.classList) continue;
                            el.classList.toggle('is-active', i === currentIndex);
                        }
                    };

                    const slideTo = (index, durationMs = 360)=>{
                        const w = (viewportEl && (viewportEl.clientWidth || viewportEl.getBoundingClientRect().width)) || eventsContainer.clientWidth || eventsContainer.getBoundingClientRect().width;
                        // 用 JS 统一控制过渡（比纯 CSS 更易做动态时长/缓动）
                        eventsContainer.style.transition = `transform ${Math.max(160, Math.min(700, Math.round(durationMs)))}ms cubic-bezier(.2,.85,.2,1)`;
                        eventsContainer.style.transform = `translate3d(-${index * Math.round(w)}px, 0, 0)`;
                        setActiveClass();
                    };
                    // 初始化并启动
                    updateItemWidths();
                    let autoInterval = null;
                    // Helper: ensure slide at index has its background image loaded
                    const ensureLoadedAt = (idx)=>{
                        if(!eventsContainer.children || !eventsContainer.children.length) return;
                        const i = ((idx % totalEvents) + totalEvents) % totalEvents;
                        const el = eventsContainer.children[i];
                        if(!el) return;
                        if(!el.classList.contains('lazy')) return; // already loaded or loading
                        const src = el.dataset && el.dataset.src;
                        if(!src) return;
                        const img = new Image();
                        img.onload = ()=>{
                            el.style.backgroundImage = `url(${src})`;
                            el.classList.remove('lazy');
                            el.classList.add('loaded');
                        };
                        img.onerror = ()=>{
                            el.classList.remove('lazy');
                            el.classList.add('loaded');
                        };
                        img.src = src + (location.search.includes('nocache') ? '' : ('?v=' + (Date.now())));
                    };
                    const startAuto = ()=>{
                        if(autoInterval) clearInterval(autoInterval);
                        // preload next two slides for smooth auto-advance
                        ensureLoadedAt(currentIndex + 1);
                        ensureLoadedAt(currentIndex + 2);
                        autoInterval = setInterval(()=>{
                            currentIndex = (currentIndex + 1) % totalEvents;
                            // preload the next two slides ahead of time
                            ensureLoadedAt(currentIndex + 1);
                            ensureLoadedAt(currentIndex + 2);
                            slideTo(currentIndex);
                        }, 4000);
                    };
                    const stopAuto = ()=>{ if(autoInterval) { clearInterval(autoInterval); autoInterval = null; } };
                    window.addEventListener('resize', ()=>{
                        updateItemWidths();
                        slideTo(currentIndex);
                    });
                    startAuto();

                    // 手动拖拽/滑动支持（pointer events）
                    let isDragging = false;
                    let startX = 0;
                    let lastTranslate = 0;
                    let itemW = 0;
                    // reuse `viewportEl` defined earlier for viewport measurements
                    const thresholdPx = 50; // 最小触发位移
                    const refreshItemW = ()=>{ itemW = (viewportEl && (viewportEl.clientWidth || viewportEl.getBoundingClientRect().width)) || eventsContainer.clientWidth; };
                    refreshItemW();

                    const setTranslate = (tx, withTransition=true)=>{
                        eventsContainer.style.transition = withTransition ? 'transform 360ms cubic-bezier(.2,.85,.2,1)' : 'none';
                        eventsContainer.style.transform = `translate3d(${tx}px, 0, 0)`;
                    };

                    // Attach pointer handlers to the viewport element to ensure consistent capture
                    const viewportElem = eventsContainer.parentElement;

                    // rAF 节流，避免 pointermove 过于频繁导致卡顿
                    let rafId = 0;
                    let pendingDx = 0;
                    let lastMoveX = 0;
                    let lastMoveT = 0;
                    let velocityX = 0; // px/ms

                    const onPointerMove = (ev)=>{
                        if(!isDragging) return;
                        // 记录速度（用于甩动）
                        const now = performance.now();
                        const x = ev.clientX;
                        const dt = Math.max(1, now - lastMoveT);
                        const dxInst = x - lastMoveX;
                        // 低通滤波，让速度更稳定
                        velocityX = velocityX * 0.75 + (dxInst / dt) * 0.25;
                        lastMoveX = x;
                        lastMoveT = now;

                        pendingDx = x - startX;
                        if(!rafId){
                            rafId = requestAnimationFrame(()=>{
                                rafId = 0;
                                setTranslate(lastTranslate + pendingDx, false);
                            });
                        }
                    };

                    const endDrag = (ev)=>{
                        if(!isDragging) return;
                        isDragging = false;
                        if(rafId){
                            cancelAnimationFrame(rafId);
                            rafId = 0;
                        }
                        const dx = (ev && typeof ev.clientX === 'number') ? (ev.clientX - startX) : pendingDx;

                        // 甩动优先：速度足够则按速度方向翻页
                        const flick = 0.65; // px/ms ~= 650px/s
                        const movedEnough = Math.abs(dx) > Math.max(thresholdPx, itemW * 0.18);
                        if(Math.abs(velocityX) > flick){
                            if(velocityX > 0) currentIndex = (currentIndex - 1 + totalEvents) % totalEvents;
                            else currentIndex = (currentIndex + 1) % totalEvents;
                        }else if(movedEnough){
                            if(dx > 0) currentIndex = (currentIndex - 1 + totalEvents) % totalEvents;
                            else currentIndex = (currentIndex + 1) % totalEvents;
                        }

                        // 根据拖动距离/速度动态调整回弹时长，更“跟手”
                        const distance = Math.min(itemW, Math.abs(dx));
                        const speed = Math.min(2.2, Math.abs(velocityX));
                        const base = 260 + (distance / Math.max(1, itemW)) * 220;
                        const duration = base - speed * 80;
                        slideTo(currentIndex, duration);
                        startAuto();
                        try{ if(ev && ev.pointerId && viewportElem && viewportElem.releasePointerCapture) viewportElem.releasePointerCapture(ev.pointerId); }catch(e){}
                        // remove global move listener
                        window.removeEventListener('pointermove', onPointerMove);
                        window.removeEventListener('pointerup', endDrag);
                        window.removeEventListener('pointercancel', endDrag);
                    };

                    viewportElem.addEventListener('pointerdown', (ev)=>{
                        // only handle primary button/touch
                        if(ev.button !== 0) return;
                        ev.preventDefault();
                        isDragging = true;
                        startX = ev.clientX;
                        lastMoveX = ev.clientX;
                        lastMoveT = performance.now();
                        velocityX = 0;
                        refreshItemW();
                        lastTranslate = -currentIndex * Math.round(itemW);
                        // 立即关闭过渡，避免拖拽第一帧“带惯性”
                        eventsContainer.style.transition = 'none';
                        stopAuto();
                        // preload neighbors: next/prev and two-away slides for smooth drag
                        ensureLoadedAt(currentIndex + 1);
                        ensureLoadedAt(currentIndex - 1);
                        ensureLoadedAt(currentIndex + 2);
                        ensureLoadedAt(currentIndex - 2);
                        try{ if(viewportElem && viewportElem.setPointerCapture) viewportElem.setPointerCapture(ev.pointerId); }catch(e){}
                        // attach global listeners so we continue to receive moves/up outside element
                        window.addEventListener('pointermove', onPointerMove, { passive: true });
                        window.addEventListener('pointerup', endDrag);
                        window.addEventListener('pointercancel', endDrag);
                    });

                    // 初始化高亮
                    setActiveClass();
                }
            }
        }catch(err){
            console.warn('加载站点配置失败，使用默认内容。', err);
        }
        
        document.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter'){
                const active = document.activeElement;
                if(active && active.classList && active.classList.contains('post-item')){
                    active.animate([{transform:'translateY(0)'},{transform:'translateY(1px)'},{transform:'translateY(0)'}],{duration:180});
                }
            }
        });
    })();
    </script>
</body>
</html>